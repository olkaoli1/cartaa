name: tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Chromedriver
        uses: nanasess/setup-chromedriver@v2
        with:
          chromedriver-version: '124.0.6367.0'
          
      - name: Start app
        run: |
          nohup java -jar artifacts/app-card-delivery.jar >/dev/null 2>&1 &
          for i in {1..15}; do nc -z localhost 9999 && break; sleep 1; done

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Run tests (headless)
        env:
          CHROME_DRIVER_PATH: /usr/local/bin/chromedriver
        run: ./gradlew clean test -Pheadless=true
